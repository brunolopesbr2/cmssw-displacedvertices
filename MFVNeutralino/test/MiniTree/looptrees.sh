#!/usr/bin/bash

ntk=5
indir=/eos/user/b/brlopesd/StealthSUSY_Minitrees_2017
outdir=output
files=(
mfv_StealthSHH_mStop_300_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_0p01_2017.root
mfv_StealthSHH_mStop_300_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_0p1_2017.root
mfv_StealthSHH_mStop_300_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_1_2017.root
mfv_StealthSHH_mStop_300_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_10_2017.root
mfv_StealthSHH_mStop_300_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_100_2017.root
mfv_StealthSHH_mStop_300_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_300_mS_75_ctau_1000_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_0p01_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_0p1_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_1_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_10_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_100_2017.root
mfv_StealthSYY_mStop_300_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_300_mS_75_ctau_1000_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_0p01_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_0p1_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_1_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_10_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_100_2017.root
mfv_StealthSHH_mStop_500_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_500_mS_275_ctau_1000_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_0p01_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_0p1_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_1_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_10_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_100_2017.root
mfv_StealthSYY_mStop_500_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_500_mS_275_ctau_1000_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_0p01_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_0p1_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_1_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_10_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_100_2017.root
mfv_StealthSHH_mStop_700_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_700_mS_475_ctau_1000_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_0p01_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_0p1_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_1_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_10_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_100_2017.root
mfv_StealthSYY_mStop_700_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_700_mS_475_ctau_1000_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_0p01_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_0p1_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_1_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_10_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_100_2017.root
mfv_StealthSHH_mStop_900_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_900_mS_675_ctau_1000_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_0p01_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_0p1_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_1_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_10_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_100_2017.root
mfv_StealthSYY_mStop_900_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_900_mS_675_ctau_1000_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_1_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_10_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_100_2017.root
mfv_StealthSHH_mStop_1100_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_1100_mS_875_ctau_1000_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_1_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_10_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_100_2017.root
mfv_StealthSYY_mStop_1100_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_1100_mS_875_ctau_1000_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_1_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_10_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_100_2017.root
mfv_StealthSHH_mStop_1300_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_1300_mS_1075_ctau_1000_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_1_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_10_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_100_2017.root
mfv_StealthSYY_mStop_1300_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_1300_mS_1075_ctau_1000_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_0p01_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_0p1_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_1_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_1_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_10_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_10_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_100_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_100_2017.root
mfv_StealthSHH_mStop_1500_mS_100_ctau_1000_2017.root
mfv_StealthSHH_mStop_1500_mS_1275_ctau_1000_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_0p01_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_0p1_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_1_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_1_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_10_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_10_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_100_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_100_2017.root
mfv_StealthSYY_mStop_1500_mS_100_ctau_1000_2017.root
mfv_StealthSYY_mStop_1500_mS_1275_ctau_1000_2017.root
)
intlumi=$(python -c 'import JMTucker.MFVNeutralino.AnalysisConstants as ac; print ac.int_lumi_2017 * ac.scale_factor_2017')

########################################################################

if [[ -d $outdir ]]; then
    echo $outdir already exists
    exit 1
fi

mkdir $outdir

make
if [[ $? != 0 ]]; then
    exit 1
fi

outbackgrounds=()
outsignals=()

for x in ${files[@]}; do
    fin=$indir/$x
    fout=$outdir/$x
    if [[ ! -e $fin ]]; then
        echo $fin missing
        exit 1
    fi

    echo $x
    ./looptrees.exe $fin $fout $ntk
    if [[ $? != 0 ]]; then
        echo problem, exit code was $?
        exit 1
    fi

    if [[ $x != mfv* ]]; then
        outbackgrounds+=($fout)
    else
        outsignals+=($fout)
    fi
done

samples merge -${intlumi} $outdir/background.root ${outbackgrounds[@]}

echo; echo scaling files, do not rerun merge background or use the h_sums in these files after this
for x in ${outbackgrounds[@]} ${outsignals[@]}; do
    y=$outdir/temp.root
    samples merge -${intlumi} $x $y
    mv $x ${x/.root/.unscaled.root}
    mv $y $x
done
